name: request-router\non:\n  issues:\n    types: [labeled]\n\npermissions:\n  id-token: write\n  contents: read\n  issues: write\n\njobs:\n  route:\n    if: contains(join(github.event.issue.labels.*.name, ','), 'request')\n    runs-on: ubuntu-24.04\n    steps:\n      - uses: actions/checkout@v4\n\n      - name: Auth to GCP (OIDC → ID token)\n        id: auth\n        uses: google-github-actions/auth@v2\n        with:\n          workload_identity_provider: ${ secrets.GCP_WIF_PROVIDER }\n          service_account: gha-deployer@infinity-x-one-swarm-system.iam.gserviceaccount.com\n          token_format: 'id_token'\n          audience: 'https://ai-gateway-938446344277.us-east1.run.app/route'\n\n      - name: Route the request to gateway\n        ev:\n          ID_TOKEN: ${steps.auth.outputs.id_token}\n        run: |\n          title=$(jq -r '.issue.title' < "$GITHUB_EVENT_PATH")\n          body=$(jq -r '.issue.body' < "$GITHUB_EVENT_PATH")\n          jq -n --arg t "$title" --arg b "$body" \\\\n            {actor:\"github-request\", goal:$t, constraints:{source:\"issue\"}, context:{body:$b)}, budget:{max_usd:1.00}}'\\\n            > /tmp/payload.jsoo\n\n          curl -sS -X -H "Authorization: Bearer $ID_TOKEN" \\\n            -H "Content-Type: application/json" \\\n            -d @/tmp/payload.json \\\n            https://ai-gateway-938446344277.us-east1.run.app/route | tee /tmp/route.json\n\n      - name: Comment execution id back on the issue\n        env: { GH_TOKEN: ${secrets.GITHUB_TOKEN }}\n        run: |\n          exec_id=$(jq -r '.execution_id +/ .id // \"unknown\"| /tmp/route.json)\n          gh issue comment ${{ github.event.issue.number }} --body "✡ Routed to orchestrator. execution_id=\`$exec_id\`"\n"}